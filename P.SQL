SELECT
    HRV.DESREBOTE,
    HRV.CELULAR,
    C.LATITUD LATITUDCLIENTE,
    C.LONGITUD LONGITUDCLIENTE,
    C.DIRECCION,
    HRV.CODIGOSISTEMAUSUARIOCELULAR,
    HRV.NOMBREOPERATIVO,
    CASE
        WHEN (
            P.LATITUD IS NULL
            AND HRV.LATITUD IS NULL
        ) THEN C.LATITUD
        WHEN HRV.LATITUD IS NULL THEN P.LATITUD
        ELSE HRV.LATITUD
    END LATITUDMARCACION,
    IIF(
        HRV.OBSERVACIONINICIO IS NULL
        OR HRV.OBSERVACIONINICIO = '',
        HRV.OBSERVACIONFIN,
        HRV.OBSERVACIONINICIO
    ) OBS,
    CASE
        WHEN (
            P.LONGITUD IS NULL
            AND HRV.LONGITUD IS NULL
        ) THEN C.LONGITUD
        WHEN HRV.LONGITUD IS NULL THEN P.LONGITUD
        ELSE HRV.LONGITUD
    END LONGITUDMARCACION,
    HRV.FECHAINICIO AS FECHAINICIO,
    IIF(
        C.LATITUD IS NULL
        OR C.LATITUD = 0,
        'SIN GEOREFERENCIA',
        C.LATITUD
    ) GEO,
    IIF(
        HRV.HORAINICIO IS NULL,
        '23:00:00',
        SUBSTRING(
            HRV.HORAINICIO
            FROM
                1 FOR 8
        )
    ) AS HORAINICIO,
    HRV.HORAFIN,
    HRV.HORAINICIO - HRV.HORAFIN AS TIEMPO,
    C.CODIGOCORTO CODIGOSISTEMACLIENTE,
    C.CODIGOSISTEMASUCURSAL,
    C.RAZONSOCIAL,
    HRV.OBSERVACIONINICIO,
    HRV.OBSERVACIONFIN,
    HRV.ID_PEDIDO,
    P.TOTALGRAL,
    HRV.ID_HISTORICORUTAVISITA,
    HRV.ORIGEN,
    (
        SELECT
            COUNT(ID_PEDIDO)
        FROM
            HISTORICOSRUTASVISITAS
        WHERE
            CODIGOSISTEMAUSUARIOCELULAR = hrv.CODIGOSISTEMAUSUARIOCELULAR
            AND FECHAINICIO BETWEEN (:FECHADESDE)
            AND (:FECHAHASTA)
            AND DESREBOTE <> 'CENSO'
            AND CODIGOSISTEMACLIENTE = HRV.CODIGOSISTEMACLIENTE
            AND ID_PEDIDO IS NOT NULL
    ) CANTPEDIDO,
    CC.CODIGOSISTEMA CODSUCURSAL,
    HRV.KILOMETRAJE,
    HRV.RAZONSOCIAL RAZONSOCIALHISTORICO,
    S.CODIGOSISTEMA CODSUPERVISOR,
    IIF(
        S.DESCRIPCION IS NULL
        OR S.DESCRIPCION = '',
        'SIN SUPERVISOR',
        S.DESCRIPCION
    ) DESSUPERVISOR,
    EXTRACT(
        HOUR
        FROM
            HRV.HORAINICIO
    ) HORA
FROM
    HISTORICOSRUTASVISITAS HRV
    LEFT JOIN CLIENTES C ON (C.ID_CLIENTE = HRV.ID_CLIENTE)
    LEFT JOIN PEDIDOS P ON (P.ID_PEDIDO = HRV.ID_PEDIDO)
    LEFT JOIN USUARIOSCELULARES UC ON (
        HRV.CODIGOSISTEMAUSUARIOCELULAR = UC.CODIGOSISTEMA
    )
    LEFT JOIN TIPOSUSUARIOSCELULARES TU ON (
        TU.CODIGOSISTEMA = UC.CODIGOSISTEMATIPOUSUARIOCEL
    )
    LEFT JOIN CLIENTESCUENTAS CC ON (
        CC.CODIGOSISTEMA = HRV.KILOMETRAJE
        AND CC.ESTADO = 'ACTIVO'
    )
    LEFT JOIN SUPERVISORES S ON (S.CODIGOSISTEMA = UC.CODIGOSISTEMASUPERVISOR)
WHERE
    --HRV.FECHAINICIO BETWEEN (:FECHADESDE) AND (:FECHAHASTA)
    HRV.FECHAINICIO = '2020-01-06'
    AND UC.ESTADO = 'ACTIVO'
    AND TU.MODULO = 'PREVENTA'
    AND HRV.CODIGOSISTEMACLIENTE <> '50128591'
    AND HRV.DESREBOTE <> 'CENSO'
    /*AND HRV.ID_PEDIDO IS NULL*/
ORDER BY
    EXTRACT(
        HOUR
        FROM
            HRV.HORAINICIO
    ) DESC